########################################################################
#
# byteman script used to ensure that tests can synchronize with various
# actions performed by the recovery code

#########################################################################
# rules to identify progress of the periodic recovery listener thread
#

# if a test has set up a rendezvous under key "PR listener run" then
# flag the listener so that it enters the rendezvous when it starts runnning

RULE periodic recovery set up listener for rendezvous
CLASS com.arjuna.ats.internal.arjuna.recovery.PeriodicRecovery
METHOD <init>
AT CALL  Listener.start
BIND pr : PeriodicRecovery = $0
IF isRendezvous("PR listener run", 2)
DO debug("flagging PR listener"),
   flag(pr.getListener())
ENDRULE

# if the listener has been flagged then make it enter
# the PR run rendezvous just before calling accept

RULE listener rendezvous at run
CLASS com.arjuna.ats.internal.arjuna.recovery.Listener
METHOD run()
AT ENTRY
BIND listener : Listener = $0
IF flagged(listener) && isRendezvous("PR listener run", 2)
DO debug("listener rendezvous at PR listener run"),
   rendezvous("PR listener run")
ENDRULE

#########################################################################
#
# rules appropriate to specific tests

#########################################################################
# RecoveryManagerStartStopTest wants to rendezvous at the point where
# the periodic recovery worker service has started running
#

# set up the PR listener rendezvous and add a rendezvous
# for the Connection class to enter once it is started

RULE RecoveryManagerStartStopTest create rendezvous
CLASS com.hp.mwtests.ts.arjuna.recovery.RecoveryManagerStartStopTest
METHOD testStartStop()
AT ENTRY
BIND NOTHING
IF TRUE
DO debug("create rendezvous for PR listener run"),
   createRendezvous("PR listener run", 2),
   createRendezvous("RecoveryManagerStartStopTest Connection run", 3)
ENDRULE

# rendezvous with the PR listener to make sure it has started before
# any listener clients are added

RULE RecoveryManagerStartStopTest rendezvous before adding clients
CLASS com.hp.mwtests.ts.arjuna.recovery.RecoveryManagerStartStopTest
METHOD testStartStop()
AT CALL addRecoveryClient
BIND NOTHING
IF TRUE
DO debug("RecoveryManagerStartStopTest rendezvous at PR listener run"),
   rendezvous("PR listener run")
ENDRULE

# make the connection threads rendezvous with the test thread

RULE RecoveryManagerStartStopTest connection rendezvous at run
CLASS com.arjuna.ats.internal.arjuna.recovery.Connection
METHOD run()
AT CALL doWork
BIND NOTHING
IF isRendezvous("RecoveryManagerStartStopTest Connection run", 3)
DO debug("connection rendezvous at doWork"),
   rendezvous("RecoveryManagerStartStopTest Connection run")
ENDRULE

# make the test threads rendezvous with the connection thread
# this ensures the shutdown does not happen until the connection threads
# have started running

RULE RecoveryManagerStartStopTest rendezvous after client connections started
CLASS com.hp.mwtests.ts.arjuna.recovery.RecoveryManagerStartStopTest
METHOD testStartStop()
AFTER CALL addRecoveryClient 2
BIND NOTHING
IF TRUE
DO debug("RecoveryManagerStartStopTest rendezvous after 2nd addRecoveryClient"),
   rendezvous("RecoveryManagerStartStopTest Connection run")
ENDRULE

